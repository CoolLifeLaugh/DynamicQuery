<!DOCTYPE html>
<!--[if IE 8]>
<html lang="en" class="ie8 no-js"> <![endif]-->
<!--[if IE 9]>
<html lang="en" class="ie9 no-js"> <![endif]-->
<!--[if !IE]><!-->
<html lang="en">
<!--<![endif]-->
<!-- BEGIN HEAD -->

<head>
    <meta charset="utf-8" />
    <title>供应链后台</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <!-- BEGIN GLOBAL MANDATORY STYLES -->
    <link href="../assets/global/plugins/font-opensans/font-opensans.css" rel="stylesheet" type="text/css" />
    <link href="../assets/global/plugins/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <link href="../assets/global/plugins/simple-line-icons/simple-line-icons.min.css" rel="stylesheet"
        type="text/css" />
    <link href="../assets/global/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="../assets/global/plugins/uniform/css/uniform.default.css" rel="stylesheet" type="text/css" />
    <!-- END GLOBAL MANDATORY STYLES -->
    <!-- BEGIN PAGE LEVEL STYLES -->
    <link href="../assets/pages/css/login.css" rel="stylesheet" type="text/css" />
    <!-- END PAGE LEVEL SCRIPTS -->
    <!-- BEGIN THEME STYLES -->
    <link href="../assets/global/css/components-rounded.css" id="style_components" rel="stylesheet" type="text/css" />
    <link href="../assets/global/css/plugins.css" rel="stylesheet" type="text/css" />
    <link href="../assets/layout/css/layout.css" rel="stylesheet" type="text/css" />
    <link href="../assets/layout/css/themes/darkblue.css" rel="stylesheet" type="text/css" id="style_color" />
    <link href="../assets/layout/css/custom.css" rel="stylesheet" type="text/css" />
    <!-- END THEME STYLES -->
    <link rel="shortcut icon" href="favicon.ico" />
    <!--jigsaw styles sheet-->
    <link rel="stylesheet" href="../assets/layout/css/jigsaw.css">
</head>
<!-- END HEAD -->
<!-- BEGIN BODY -->

<body class="login">
    <!-- BEGIN SIDEBAR TOGGLER BUTTON -->
    <div class="menu-toggler sidebar-toggler"></div>
    <!-- END SIDEBAR TOGGLER BUTTON -->
    <!-- BEGIN LOGO -->
    <div class="logo">
        <a>
            <!-- 自动化测试绑定元素 -->
            <img src="../assets/layout/img/logo-big.png" id="logoImg">
        </a>
    </div>
    <!-- END LOGO -->
    <!-- BEGIN LOGIN -->
    <div class="content clearfix">
        <!-- BEGIN LOGIN FORM -->
        <form class="login-form" onsubmit="return false;">
            <div class="form-group">
                <!--ie8, ie9 does not support html5 placeholder, so we just show field title for that-->
                <label class="control-label visible-ie8 visible-ie9">用户名</label>
                <div class="input-icon">
                    <i class="fa fa-user"></i>
                    <input class="form-control placeholder-no-fix" type="text" autocomplete="off" placeholder="用户名"
                        name="username" />
                </div>
            </div>
            <div class="form-group">
                <label class="control-label visible-ie8 visible-ie9">密码</label>
                <div class="input-icon">
                    <i class="fa fa-lock"></i>
                    <input class="form-control placeholder-no-fix" type="password" autocomplete="off" placeholder="密码"
                        name="password" />
                </div>
            </div>

            <div class="form-group clearfix">
                <div id="captcha" style="position: relative"></div>
                <!--<input type="text" name="code" placeholder="验证码" class="form-control form-control-yzm pull-left" size="8"-->
                <!--maxlength="4" autocomplete="off">-->
                <!--<a><img class="validate-code" onclick="changeImg()"/></a>-->
            </div>
            <div class="errorContainer">
                <label id="username-error" class="error" style="display: none;">请输入用户名.</label>
                <label id="password-error" class="error" style="display: none;">请输入密码.</label>
            </div>
            <!--<div class="form-actions">-->
            <!--<button type="submit" class="btn btn-primary btn-lg btn-block" id="btn_login">登录 <i-->
            <!--class="m-icon-swapright m-icon-white"></i></button>-->
            <!--</div>-->
        </form>
        <!-- END LOGIN FORM -->
    </div>
    <div class="copyright">Copyright <sup>&copy;</sup> 2016 北京<span class="appName"></span>电子商务有限公司.</div>
    <!-- END LOGIN -->
    <!-- BEGIN CORE PLUGINS -->
    <!--[if lt IE 9]>
<script src="../assets/global/plugins/respond.min.js"></script>
<script src="../assets/global/plugins/excanvas.min.js"></script>
<![endif]-->

    <script src="../assets/global/plugins/jquery.min.js" type="text/javascript"></script>
    <script src="../assets/global/plugins/jquery-validation/js/jquery.validate.min.js" type="text/javascript"></script>
    <script src="../assets/global/plugins/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="../assets/global/plugins/bootbox/bootbox.min.js" type="text/javascript"></script>
    <script src="../assets/global/plugins/gt.js" type="text/javascript"></script>
    <script src="../assets/layout/scripts/jigsaw.js" type="text/javascript"></script>
    <script>

        // function changeImg() {
        //     $(".validate-code").attr("src", "verify/code.jpg?timestamp=" + (new Date()).valueOf());
        // }

        /***
         * 表单验证 旧方法 暂时没用到
         * */
        var initFormValid = function () {
            var validator = $(".login-form").validate({
                focusInvalid: true, // focus the last invalid input
                rules: {
                    username: {
                        required: true
                    },
                    password: {
                        required: true
                    },
                    // code: {
                    //     required: true
                    // }
                },
                messages: {
                    username: {
                        required: "请输入用户名."
                    },
                    password: {
                        required: "请输入密码."
                    },
                    // code: {
                    //     required: "请输入验证码."
                    // }
                },
                errorPlacement: function (error, element) {
                    error.appendTo($(".errorContainer"));
                },
                submitHandler: function (form) {
                }
            });
        }

        // var ele = document.getElementById("captcha");
        // var jig;

        /***
         * jQuery滑块验证 第三方插件jigsaw
         * */
        jQuery(document).ready(function () {
            // changeImg();
            // initGeeTest();
            // jig=new jigsaw(ele, function() {
            //     validateLogin()
            // })
            // jig.init();
        });

        /***
         * 极验成功后 登录
         * */
        var validateLogin = function () {
            var name = $('.login-form [name=username]').val() || ""
            var password = $('.login-form [name=password]').val() || ""
            if (name != "" && password != "") {
                $.ajax({
                    method: "post",
                    url: "user/userLogin",
                    async: false,
                    data: {
                        username: name,
                        password: password
                    },
                    dataType: 'json',
                    success: function (data) {
                        if (data.success == true) {
                            //登录成功
                            window.location.href = "index.html";
                        } else {
                            // changeImg();
                            //TODO bjw 显示在错误提示区
                            $("#code").val("");
                            bootbox.alert(data.error || data.message, function () { });
                        }
                    },
                    error: function (data) {
                        // changeImg();
                        bootbox.alert(data.error || data.message, function () { });
                    }
                });
            } else if (name == "" && password == "") {
                $('.login-form [name=username]').focus()
                $('#username-error').show()
                $('#password-error').show()
                // jig.reset();
                // jigsaw.reset(ele);
            } else if (password == "") {
                $('.login-form [name=password]').focus()
                $('#password-error').show()
                // jig.reset();
                // jigsaw.reset(ele);
            } else if (name == "") {
                $('.login-form [name=username]').focus()
                $('#username-error').show()
                // jig.reset();
                // jigsaw.reset(ele);
            }
        }

        /***
         * 检测到账号密码有输入时，隐藏提示信息
         * */
        $('.login-form [name=username]').on('input', function (e) {
            var v = $(e.target).val();
            if (v != '') $('#username-error').hide();
        })
        $('.login-form [name=password]').on('input', function (e) {
            var v = $(e.target).val();
            if (v != '') $('#password-error').hide();
        })

        /***
         * 极验 code 滑块验证
         * */
        var geeTest = function () {
            var timeStr = (new Date()).getTime()
            $.ajax({
                method: 'GET',
                url: '/getCheck?mobileNo=' + timeStr,//获取极验 验证码
                isService: true
            }).done(function (res) {
                var obj = $.parseJSON(res)
                // 调用 initGeetest 进行初始化
                // 参数1：配置参数
                // 参数2：回调，回调的第一个参数验证码对象，之后可以使用它调用相应的接口
                initGeetest({
                    // 以下 4 个配置参数为必须，不能缺少
                    gt: obj.gt,
                    challenge: obj.challenge,
                    offline: !obj.success, // 表示用户后台检测极验服务器是否宕机
                    new_captcha: obj.new_captcha, // 用于宕机时表示是新验证码的宕机
                    product: "popup", // 产品形式，包括：float，popup, custom
                    width: "100%"
                    // 更多配置参数说明请参见：http://docs.geetest.com/install/client/web-front/
                }, handlerCaptcha);
            });
            var handlerCaptcha = function (captchaObj) {
                // 将验证码加到id为captcha的元素里
                captchaObj.appendTo("#captcha");
                // 渲染验证条
                captchaObj.onSuccess(function () {//极验成功 callBack
                    var result = captchaObj.getValidate();
                    var picValidatecode = result.geetest_challenge + ',' + result.geetest_validate + ',' + result.geetest_seccode;
                    // if (result) initFormValid();
                    $.ajax({
                        url: '/checkValidatecode',
                        type: 'POST',
                        data: {
                            mobileNo: timeStr,
                            picValidatecode: picValidatecode
                        },
                        dataType: 'json'
                    }).done(function (res) {
                        if (result) validateLogin();
                        captchaObj.reset();
                    })

                });
            };
        }
        geeTest();
        /***
         * 判断是否为自动化测试账号，是则直接登录、不是则需要进入极验验证
         * */
        $("#logoImg").on("click", function () {
            var accountStr = $('.login-form [name=username]').val() || "";
            if (accountStr != "" && accountStr == "18186663337") {
                validateLogin();
            }
        })
    </script>
    <!-- END JAVASCRIPTS -->
</body>
<!-- END BODY -->

</html>